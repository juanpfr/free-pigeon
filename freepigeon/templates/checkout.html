{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finalizar Compra - Free Pigeon</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/checkout.css' %}">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* Estilos para o loading e mensagens de erro */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .loading.active {
      display: flex;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
    
    .error-message.active {
      display: block;
    }
    
    .btn-confirm:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div id="app">
    {% include 'partials/header.html' %}

    <main class="checkout-main">
      <h1>Finalizar Compra</h1>

      {% if itens %}
      <div class="checkout-container">

        <!-- Mensagem de Erro -->
        <div id="error-message" class="error-message"></div>

        <!-- Endere√ßo -->
        <section class="address-section">
          <h2>Endere√ßo de Entrega</h2>
          <form id="checkout-form" class="address-form">
            {% csrf_token %}

            <div class="form-group">
              <label for="cep">CEP</label>
              <input type="text" id="cep" name="cep" placeholder="00000-000"
                     value="{{ endereco.cep|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="rua">Rua</label>
              <input type="text" id="rua" name="rua" placeholder="Nome da Rua"
                     value="{{ endereco.rua|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="numero">N√∫mero</label>
              <input type="text" id="numero" name="numero" placeholder="N¬∫"
                     value="{{ endereco.numero|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="bairro">Bairro</label>
              <input type="text" id="bairro" name="bairro" placeholder="Bairro"
                     value="{{ endereco.bairro|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="cidade">Cidade</label>
              <input type="text" id="cidade" name="cidade" placeholder="Cidade"
                     value="{{ endereco.cidade|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="estado">Estado</label>
              <input type="text" id="estado" name="estado" placeholder="UF" maxlength="2"
                     value="{{ endereco.estado|default:'' }}" required>
            </div>

            <div class="form-group">
              <label for="complemento">Complemento</label>
              <input type="text" id="complemento" name="complemento"
                     placeholder="Apartamento, bloco, etc."
                     value="{{ endereco.complemento|default:'' }}">
            </div>

            <h2>M√©todo de Pagamento</h2>
            <div class="payment-methods">
              <label>
                <input type="radio" name="pagamento" value="cartao" checked required> 
                Cart√£o de Cr√©dito (Stripe)
              </label>
            </div>
            
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
              ‚úì Pagamento seguro processado pelo Stripe<br>
              ‚úì Aceita todos os principais cart√µes de cr√©dito
            </p>
        </section>

        <!-- Resumo do Pedido -->
        <aside class="order-summary">
          <h2>Resumo do Pedido</h2>
          <ul class="order-items">
            {% for item in itens %}
              <li class="order-item">
                <img src="{{ item.produto.imagem.url|default:'/static/img/sem-imagem.png' }}"
                     alt="{{ item.produto.nome }}">
                <div class="details">
                  <span>{{ item.produto.nome }}</span>
                  <small>{{ item.quantidade }}x 
                    R$ {{ item.produto.preco_final|floatformat:2 }}
                  </small>
                </div>
                <span class="subtotal">
                  R$ {{ item.subtotal|floatformat:2 }}
                </span>
              </li>
            {% endfor %}
          </ul>

          <hr>

          <p><strong>Total de Itens:</strong> {{ itens|length }}</p>
          <p><strong>Total Geral:</strong> R$ {{ total|floatformat:2 }}</p>

          <button type="submit" id="submit-button" class="btn-confirm">
            Pagar com Stripe
          </button>
        </aside>

        </form>
      </div>

      {% else %}
        <div class="checkout-empty">
          <h2>Seu carrinho est√° vazio üòï</h2>
          <p>Adicione produtos antes de finalizar a compra.</p>
          <a href="{% url 'home' %}" class="btn-back">Voltar para a loja</a>
        </div>
      {% endif %}
    </main>

    {% include 'partials/footer.html' %}

    <!-- Loading Overlay -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <script src="{% static 'js/main.js' %}"></script>
  
  <script>
    // Inicializar Stripe com sua chave p√∫blica
    const stripe = Stripe('{{ stripe_public_key }}');
    
    // Elementos do DOM
    const checkoutForm = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    const errorMessage = document.getElementById('error-message');
    const loadingOverlay = document.getElementById('loading');

    // Fun√ß√£o para mostrar erro
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('active');
      setTimeout(() => {
        errorMessage.classList.remove('active');
      }, 5000);
    }

    // Fun√ß√£o para obter o CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Handler do formul√°rio
    checkoutForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validar campos obrigat√≥rios
      if (!checkoutForm.checkValidity()) {
        checkoutForm.reportValidity();
        return;
      }

      // Desabilitar bot√£o e mostrar loading
      submitButton.disabled = true;
      submitButton.textContent = 'Processando...';
      loadingOverlay.classList.add('active');

      try {
        // Coletar dados do formul√°rio
        const formData = new FormData(checkoutForm);
        
        // Enviar requisi√ß√£o para criar sess√£o do Stripe
        const response = await fetch('{% url "create_checkout_session" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: new URLSearchParams(formData)
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Redirecionar para o checkout do Stripe
        const result = await stripe.redirectToCheckout({
          sessionId: data.sessionId
        });

        if (result.error) {
          throw new Error(result.error.message);
        }

      } catch (error) {
        console.error('Erro:', error);
        showError(error.message || 'Ocorreu um erro ao processar o pagamento. Tente novamente.');
        
        // Reabilitar bot√£o
        submitButton.disabled = false;
        submitButton.textContent = 'Pagar com Stripe';
        loadingOverlay.classList.remove('active');
      }
    });

    // Buscar CEP (se voc√™ j√° tem essa funcionalidade)
    const cepInput = document.getElementById('cep');
    if (cepInput) {
      cepInput.addEventListener('blur', async function() {
        const cep = this.value.replace(/\D/g, '');
        
        if (cep.length === 8) {
          try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            
            if (!data.erro) {
              document.getElementById('rua').value = data.logradouro || '';
              document.getElementById('bairro').value = data.bairro || '';
              document.getElementById('cidade').value = data.localidade || '';
              document.getElementById('estado').value = data.uf || '';
              document.getElementById('numero').focus();
            }
          } catch (error) {
            console.error('Erro ao buscar CEP:', error);
          }
        }
      });
    }
  </script>
</body>
</html>
